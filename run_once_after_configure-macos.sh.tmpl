#!/usr/bin/env bash

{{ if eq .chezmoi.os "darwin" }}
set -euo pipefail

echo "Configuring macOS defaults..."

# Close any open System Preferences panes
osascript -e 'tell application "System Preferences" to quit'

# ==============================================================================
# Input
# ==============================================================================

# Trackpad: enable tap to click
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Enable full keyboard access (Tab in modal dialogs)
defaults write NSGlobalDomain AppleKeyboardUIMode -int 3

# Set keyboard repeat rate to Fast and delay to Short (UI values)
defaults write NSGlobalDomain KeyRepeat -int 2
defaults write NSGlobalDomain InitialKeyRepeat -int 15

# ==============================================================================
# Window Management
# ==============================================================================

# Enable margins for tiled windows
defaults write com.apple.WindowManager EnableTiledWindowMargins -bool true

# Hide desktop icons (only show in Stage Manager)
defaults write com.apple.WindowManager StandardHideDesktopIcons -bool true

# ==============================================================================
# Finder
# ==============================================================================

# Keep folders on top when sorting by name
defaults write com.apple.finder _FXSortFoldersFirst -bool true

# Search the current folder by default
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

# ==============================================================================
# Dock
# ==============================================================================

# Remove all apps from the Dock
defaults write com.apple.dock persistent-apps -array

# Configure Dock
defaults write com.apple.dock tilesize -int 48
defaults write com.apple.dock autohide -bool true
defaults write com.apple.dock show-recents -bool false

# ==============================================================================
# Software Updates
# ==============================================================================

defaults write com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true
defaults write com.apple.SoftwareUpdate ScheduleFrequency -int 1
defaults write com.apple.SoftwareUpdate AutomaticDownload -int 1
defaults write com.apple.SoftwareUpdate CriticalUpdateInstall -int 1

# ==============================================================================
# Widgets
# ==============================================================================

# Hide widgets from desktop and Stage Manager
defaults write com.apple.WindowManager StandardHideWidgets -bool true
defaults write com.apple.WindowManager StageManagerHideWidgets -bool true

# ==============================================================================
# Apply Changes
# ==============================================================================

for app in "cfprefsd" "Dock" "Finder" "SystemUIServer"; do
	killall "${app}" &> /dev/null || true
done

echo "macOS defaults configured! Some changes require logout/restart."

{{ end }}
